name: Dockeré•œåƒæ„å»ºä¸æ¨é€  

on:
  push:
    branches: [ "git","dev"]  #æ¨é€åˆ°[]åˆ†æ”¯æ—¶è§¦å‘
    paths:
      - '**/Dockerfile*'      # æ•è·æ‰€æœ‰ä»¥ Dockerfile å¼€å¤´çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ Dockerfile å’Œ .Dockerfile
      - '**/.dockerfile*'     # æ•è·ä»¥ .dockerfile å¼€å¤´çš„æ–‡ä»¶
      - '**/build.bash'       # æ•è·æ‰€æœ‰ç›®å½•ä¸‹çš„ build.bash æ–‡ä»¶
  pull_request:
    branches: ["git","dev"]  #pråˆ°[]åˆ†æ”¯æ—¶è§¦å‘
    paths:
      - '**/Dockerfile*'      # æ•è·æ‰€æœ‰ä»¥ Dockerfile å¼€å¤´çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ Dockerfile å’Œ .Dockerfile
      - '**/.dockerfile*'     # æ•è·ä»¥ .dockerfile å¼€å¤´çš„æ–‡ä»¶
      - '**/build.bash'       # æ•è·æ‰€æœ‰ç›®å½•ä¸‹çš„ build.bash æ–‡ä»¶
env:
  # å¯è®¾ç½®ä¸º docker.io æˆ– ghcr.io
  REGISTRY: docker.io
  #ä»“åº“å
  REPO_NAME: elainasuki/rc2025
  # æ˜¯å¦æ„å»ºarm64æ¶æ„çš„é•œåƒ
  BUILD_ARM64: false  # ä½ å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®æ˜¯å¦æ„å»º arm64

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€é•œåƒ  # ä¸­æ–‡ job åç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤çš„å†å²è®°å½•
      - name: è®¾ç½® Buildx æ„å»ºå™¨
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•docker 
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY == 'ghcr.io' && github.actor || secrets.DOCKER_HUB_USERNAME }}
          password: ${{ env.REGISTRY == 'ghcr.io' && secrets.GITHUB_TOKEN || secrets.DOCKER_HUB_PASSWORD }}

      - name: è®¾ç½®æ„å»ºçš„ç¯å¢ƒå˜é‡
        id: prep
        run: |
          if [[ "${{ env.REGISTRY }}" == "docker.io" ]]; then
            echo "IMAGE_REPO=${{ env.REPO_NAME }}" >> "$GITHUB_ENV"
          else
            echo "IMAGE_REPO=${{ env.REGISTRY }}/${{ env.REPO_NAME }}" >> "$GITHUB_ENV"
          fi
          echo "BUILD_ARM64=${{ env.BUILD_ARM64 }}" >> "$GITHUB_ENV"  # è®¾ç½® BUILD_ARM64 ç¯å¢ƒå˜é‡
      - name: æ£€æµ‹æ›´æ”¹å¹¶æ‰§è¡Œå¯¹åº” build.bash
        run: |
          echo "ğŸ” æ£€æµ‹æ”¹åŠ¨çš„ Dockerfile/.dockerfile/build.bash æ–‡ä»¶..."

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            RANGE="origin/${{ github.base_ref }}...${{ github.sha }}"
          else
            RANGE="${{ github.event.before }} ${{ github.sha }}"
          fi

          echo "ğŸ” æ£€æŸ¥èŒƒå›´: $RANGE"

          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only $RANGE | \
            grep -Ei '(^|/)Dockerfile|(^|/)\.dockerfile|(^|/)build\.bash')

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "âœ… æ²¡æœ‰ç›¸å…³å˜æ›´ï¼Œè·³è¿‡æ„å»ºã€‚"
            exit 0
          fi

          echo "ğŸ“„ æ£€æµ‹åˆ°å˜æ›´çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"

          # è·å–æ¯ä¸ªå˜åŠ¨æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå»é‡
          CHANGED_DIRS=$(echo "$CHANGED_FILES" | xargs -n1 dirname | sort -u)

          for dir in $CHANGED_DIRS; do
            script_path="$dir/build.bash"
            if [[ -f "$script_path" ]]; then
              echo "ğŸš€ æ‰§è¡Œ $script_path ..."
              bash "$script_path" --github-action
            else
              echo "âš ï¸ $dir ä¸­æ‰¾ä¸åˆ° build.bash ï¼Œè·³è¿‡ã€‚"
            fi
          done
